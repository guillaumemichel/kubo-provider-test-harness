# Kubo Reprovide Test Harness

Test harness for verifying that [Kubo](https://github.com/ipfs/kubo)'s DHT provide/reprovide system correctly advertises all stored content to the network.

## Background

IPFS nodes periodically advertise (provide) their content to the Kademlia DHT so other peers can discover and fetch it. Kubo's `SweepingProvider` walks through the Kademlia prefix tree, sending provider records for each stored block. This test harness verifies that all expected CIDs are advertised within a reprovide cycle.

### Key Concepts

- **CID (Content Identifier)**: Content-addressed identifier for IPFS blocks. CIDv1 with raw leaves: `multihash = 0x1220 + SHA256(content)`.
- **Kademlia ID**: `SHA256(multihash)` -- determines a block's position in the DHT prefix tree.
- **Provide record**: A DHT message announcing that a peer stores a given block. Kubo's provider logs these as structured JSON with base64-encoded multihash keys.
- **Reprovide interval**: How often Kubo re-announces all its content (configured via `Provide.DHT.Interval`).

## Test Design

The test generates 1024 small files, each crafted so that its CID's Kademlia ID has a unique 10-bit prefix (covering all values 0-1023). This ensures uniform coverage of the Kademlia prefix tree, making it easy to detect if any prefix range is being skipped during the provide sweep.

A pre-bruteforced Ed25519 identity is used whose Kademlia ID starts with `0x00`, placing the node at a known position in the DHT.

The test tracks 1026 CIDs total:
- 1024 file CIDs (one per 10-bit Kademlia prefix)
- 1 directory CID (the `generated_files/` wrapper)
- 1 empty directory CID (`QmUNLLsPACCz1vLxQVkXqqLX5R1X345qqfHbsf67hvA3Nn`)

## Files

### Main Test (Go)

| File | Description |
|---|---|
| `main.go` | Main test: inits IPFS, adds files offline, starts daemon, monitors provide logs, prints per-minute distribution of advertisement counts. Runs until Ctrl+C. |
| `generate_files.py` | Generates 1024 text files in `generated_files/`, one per unique 10-bit Kademlia prefix. Uses brute-force search over simple content strings. |

### Utilities

| File | Description |
|---|---|
| `bruteforce/main.go` | Brute-forces an Ed25519 keypair whose peer Kademlia ID starts with 8 zero bits (`0x00`). Found in ~300 attempts. The resulting identity is hardcoded in `main.go`. |
| `verify/main.go` | Cross-verification tool: reads CIDs from `cids.txt` and prints `<kademlia_id_hex> <cid>` for each. Used to confirm Python and Go CID-to-KadID conversions match. |

### Legacy Python Tests (archived)

> **Note**: The Python test (`test.py`) relies on custom structured log lines (`"sent provider records"` with JSON payload containing base64-encoded multihash keys) from a development branch of [go-libp2p-kad-dht](https://github.com/libp2p/go-libp2p-kad-dht). These logs are not available in any released version and never will be. The Python scripts are kept here for reference only.

| File | Description |
|---|---|
| `test.py` | Earlier version of the test in Python. Adds files, monitors daemon logs, classifies advertised multihashes into categories (root, other, empty dir, unknown), reports stall diagnostics. |
| `generator.py` | Reads CIDs from `cids.txt`, selects one per unique 8-bit Kademlia prefix, writes 256 CIDs to `output.txt`. |
| `gen2.py` | Generates 256 files (one per 8-bit prefix) by brute-forcing content whose CIDv1-raw has the desired Kademlia prefix. Predecessor to `generate_files.py`. |

### Data Files

| File | Description |
|---|---|
| `cids.txt` | 7341 CIDs collected from an IPFS node, used as input for `generator.py` and `verify/`. |
| `output.txt` | 256 CIDs selected by `generator.py` (one per 8-bit prefix). |
| `gen2_output.txt` | CID + KadID mapping produced by `gen2.py`. |
| `generated_files/` | 1024 text files generated by `generate_files.py`. Each contains a short number string. |

## Usage

### Generate test files

```bash
pip install py-cid  # or: poetry install
python3 generate_files.py
```

This creates 1024 files in `generated_files/`, one per 10-bit Kademlia prefix.

### Run the test

```bash
go build -o reprovide-test .
./reprovide-test
```

The test will:
1. Initialize a fresh IPFS repo in `.ipfs/` with a known peer identity
2. Configure reprovide interval (10m), strategy (`pinned`), and alternate ports (API:5401, Swarm:4401, Gateway:8480) to avoid conflicts with a running IPFS daemon
3. Add all files from `generated_files/` offline (before starting the daemon)
4. Start the Kubo daemon with `dht` and `dht/provider` debug logging
5. Parse `"sent provider record"` log lines, decode base64 multihash keys, and match against tracked CIDs
6. Print a distribution summary every minute showing how many CIDs have been advertised 0 times, 1 time, 2 times, etc.
7. Run until interrupted with Ctrl+C

### Bruteforce a new peer identity

```bash
cd bruteforce && go run .
```

Generates an Ed25519 keypair whose Kademlia ID starts with `0x00`. Output includes `PeerID` and `PrivKey` for use in the IPFS config.

## Requirements

- [Kubo](https://github.com/ipfs/kubo) (`ipfs` binary in PATH)
- Go 1.21+
- Python 3.10+ with `py-cid` (only for `generate_files.py`)

## Findings

- When files are added **while the daemon is running**, the SweepingProvider may have already passed certain prefix ranges, causing those CIDs to be missed until the next reprovide cycle. Adding files **offline** (before daemon start) ensures all blocks are present when the first sweep begins.
- Each `ipfs add` through the daemon API creates 2 blocks per file: the content block and an MFS (Mutable File System) directory wrapper block. Adding with `-r` on a directory produces the content blocks plus UnixFS directory nodes.
- The `Provide.Strategy = "pinned"` only advertises blocks reachable from pinned roots. With `"all"`, every block in the blockstore is advertised.
